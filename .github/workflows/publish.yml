name: publish

on: [release]

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: Docker

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Get tag
        id: tag
        uses: dawidd6/action-get-tag@v1
        with:
          # Optionally strip `v` prefix
          strip_v: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to docker
        run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Pulish to DockerHub
        run: |
          docker buildx build --publish --platform linux/amd64,linux/arm64 -f src/Dockerfile.prod -t rickh94/purple-auth:latest -t rickh94/purple-auth:${{steps.tag.outputs.tag}} . 
          
